name: PR Validation

on:
  pull_request:
    branches: ['master']

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: PR Quality Gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

      - name: Validate commit messages
        run: |
          # Check if commit messages follow conventional commits format
          git log --format=%s origin/master..HEAD | while read -r msg; do
            if ! echo "$msg" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+'; then
              echo "Invalid commit message: $msg"
              echo "Please follow conventional commits format: type(scope): message"
              exit 1
            fi
          done
        continue-on-error: true

      - name: Check for large files
        run: |
          # Check for files larger than 5MB
          find . -type f -size +5M -not -path "./.git/*" | while read -r file; do
            echo "Large file detected: $file"
            exit 1
          done

      - name: Analyze code complexity
        run: |
          # Install complexity checker
          npm install -g complexity-report

          # Check complexity of changed files
          git diff --name-only origin/master...HEAD | grep -E '\.(js|jsx|ts|tsx)$' | while read -r file; do
            if [ -f "$file" ]; then
              echo "Analyzing: $file"
              cr "$file" || true
            fi
          done
        continue-on-error: true

      - name: Check bundle size impact
        run: |
          # Build current branch
          npm run build
          CURRENT_SIZE=$(du -sb .next | cut -f1)

          # Checkout master and build
          git checkout origin/master
          yarn install --frozen-lockfile
          npm run build
          MASTER_SIZE=$(du -sb .next | cut -f1)

          # Calculate difference
          SIZE_DIFF=$((CURRENT_SIZE - MASTER_SIZE))
          SIZE_DIFF_MB=$((SIZE_DIFF / 1024 / 1024))

          echo "Bundle size change: ${SIZE_DIFF_MB}MB"

          if [ $SIZE_DIFF_MB -gt 5 ]; then
            echo "⚠️  Bundle size increased by more than 5MB"
            echo "Please review if this is expected"
          fi
        continue-on-error: true

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = `## PR Validation Summary

            ✅ All quality checks passed!

            ### Checks Performed:
            - Code formatting validation
            - Linting
            - Type checking
            - Unit tests
            - Security scanning
            - Build validation

            Please ensure all required checks pass before merging.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
        continue-on-error: true
